function isdigit(e){return e>="0"&&e<="9"}function issym(e){return[".",":","(",")","[","]",","].includes(e)}function iscalc(e){return["+","-","*","/","=","&","<",">","%","^"].includes(e)}var keywords_list=["procedure","endprocedure","if","then","else","endif","while","do","endwhile","for","step","endfor","declare","input","output","constant","case","endcase","repeat","until","function","endfunction","call","returns","return"];function iskwd(e){return keywords_list.includes(e)}function gentoken(e,t,n){return{type:e,val:t,col:n}}function isword(e){return e>="A"&&e<="Z"||e>="a"&&e<="z"||["_"].includes(e)}function tokenize(e,t){lineno=-38;for(var n=[],r=0;r<e.length;++r){let t=e[r];if(isdigit(t)){for(var o="";isdigit(t)||"."===t;)o+=t,t=e[++r];r--,n.push(gentoken("number",o.includes(".")?Number.parseFloat(o):Number.parseInt(o),lineno))}else if(iscalc(t))n.push(gentoken("calc",t,lineno));else if(issym(t))n.push(gentoken("sym",t,lineno));else if("\n"===t)n.push(gentoken("newline","",lineno)),lineno++;else if(isword(t)){for(var l="";isword(t);)l+=t,t=e[++r];r--,l=l.toLowerCase(),n.push(gentoken(iskwd(l)?"kwd":"wd",l,lineno))}else if("'"===t||'"'===t){const o=e.indexOf(t,r+1);if(-1===o)throw"字符串未闭合（少了引号？），在第"+lineno+"行";n.push(gentoken("string",e.substring(r+1,o),lineno)),r+=o-r}else{if(" "===t)continue;if("#"!==t)throw'未知的字符:"'+t+'",在第'+lineno+"行";for(;"\n"!==e[++r];)continue;n.push(gentoken("newline","",lineno)),lineno++}}return n}var gvm={tkidx:0,tokens:[],vars:null,stacks:[],stop:!1,inputting:!1,inputname:"",output:null,loopcnt:0,returnv:null};function cleangvm(e){gvm.tkidx=0,gvm.tokens=e,gvm.vars=new Map,gvm.stop=!1,gvm.inputting=!1,gvm.loopcnt=0,gvm.stacks=[],gvm.returnv=nil_val}function next(e=!0){if(gvm.tkidx>=gvm.tokens.length&&e)throw"你的代码异常结束（确定结尾没少些什么东西吗:)";return gvm.tokens[gvm.tkidx++]}function peek(e){if(gvm.tkidx>=gvm.tokens.length)throw"你的代码异常结束（确定结尾没少些什么东西吗:)";return gvm.tokens[gvm.tkidx].val===e}function match(e){if(gvm.tkidx>=gvm.tokens.length)throw"你的代码异常结束（确定结尾没少些什么东西吗:)";return gvm.tokens[gvm.tkidx].type===e}function eat(e){if(next().val!==e)throw"缺少 `"+e+"`"}function tobool(e){if("real"===e.type||"integer"===e.type)return 0!==e.val;if("bool"!==e.type)throw"类型："+e.type+"，无法转换为bool!";return e.val}var parser_table=new Map,syscall_table=new Map;function cvt_type(e){return"char"===e?"string":"boolean"===e?"bool":e}function getValsTable(e=!1){for(var t=new Map;;){if(!match("wd"))throw"在declare后需要变量的名称!";const o=next().val;if(eat(":"),!match("wd"))throw"在 `:` 后缺少类型名称";var n=cvt_type(next().val);if("array"===n){eat("[");for(var r=[];;){if(!match("number"))throw"缺少数组长度!";const e=next().val;if(eat(":"),!match("number"))throw"缺少数组边界(必须为常数，不接受变量或常量）!";const t=next().val;if(r.push({l:e,r:t}),!peek(","))break;next()}if(eat("]"),eat("of"),!match("wd"))throw"缺少数组的类型名!";const e=cvt_type(next().val);t.set(o,gentoken("array",{type:e,val:r,ctx:new Map}))}else t.set(o,gentoken(n,0));const l=next();if(e&&","!==l.val)return gvm.tkidx--,t;if("newline"===l.type||l.val===e)return t;if(","!==l.val)throw"这里需要 换行 来结束变量的声明!"}}function fdecl(e=!1){if(!match("wd"))throw"缺少要调用的函数名!";const t=next().val;eat("(");var n=new Map;if(peek(")")||(n=getValsTable(!0)),eat(")"),peek("returns")){if(e)throw"PROCEDURE不能有返回值，请考虑function";if(next(),!match("wd"))throw"RETURNS后需要 类型";next()}const r=gvm.tkidx;for(console.log("idx:"+r);!peek("endfunction")&&!peek("endprocedure");)next();next(),gvm.vars.set(t,{type:"func",val:{parm:n,pc:r}})}function endf(){const e=gvm.stacks.pop();throw gvm.vars=e.vars,gvm.tkidx=e.pc,"endfunction"}parser_table.set("constant",function(){if(!match("wd"))throw"在constant后需要变量的名称!";const e=next().val;eat("=");const t=expr(4);gvm.vars.set(e,{type:t.type,val:t.val})}),parser_table.set("declare",function(){const e=getValsTable();console.log(e),e.forEach((e,t)=>{console.log("dec:"+t+" , "+e),gvm.vars.set(t,e)})}),parser_table.set("call",function(){if(!match("wd"))throw"缺少要调用的过程名!"}),parser_table.set("call",function(){return!0}),parser_table.set("function",function(){fdecl()}),parser_table.set("procedure",function(){fdecl(!0)}),parser_table.set("case",function(){eat("of");const e=expr(4);for(var t=0;;){if(peek("endcase")){next();break}if(peek(":")){if(t){t=2,next();continue}for(;"newline"!==gvm.tokens[gvm.tkidx].type;)gvm.tkidx--;next();const n=expr(4);t=cmptype(e,n)&&e.val===n.val||"__otherwise__"===n.val?1:0,next()}else 1==t?process():next()}}),parser_table.set("repeat",function(){if(gvm.loopcnt>=500)throw gvm.loopcnt=0,"循环次数超过500次，疑似死循环？程序已经终止（栈溢出保护）";const e=gvm.tkidx-1;for(;gvm.tkidx<gvm.tokens.length&&!gvm.stop;){if(peek("until")){return next(),gvm.loopcnt++,!1===tobool(expr(4))?(gvm.tkidx=e,!0):(gvm.loopcnt=0,!0)}process()}throw"缺少`until`"}),parser_table.set("while",function(){if(gvm.loopcnt>=500)throw gvm.loopcnt=0,"循环次数超过500次，疑似死循环？程序已经终止（栈溢出保护）";const e=gvm.tkidx-1,t=tobool(expr(4));if(console.log(t),!1===t){for(;"endwhile"!==next().val;);return console.log("endwhile!"),gvm.loopcnt=0,!0}for(;gvm.tkidx<gvm.tokens.length&&!gvm.stop;){if(peek("endwhile"))return gvm.loopcnt++,gvm.tkidx=e,!0;process()}throw"缺少 `ENDWHILE`"}),parser_table.set("for",function(){if(!match("wd"))throw"FOR循环需要一个计次变量 (例如 i<-1)";const e=next().val;gvm.vars.set(e,gentoken("integer",0)),gvm.tkidx--,expr(4);var t=gvm.vars.get(e);eat("to");const n=expr(4);if(!isnumeric(n))throw"TO 后面的值必须是一个number";var r=1;if(peek("step")){next();const e=expr(4);if(!isnumeric(e))throw"STEP 后面的值必须是一个number!";r=e.val}const o=gvm.tkidx;for(console.log("initial:"+t.val+",to:"+n.val+",step:"+r);t.val<=n.val;){for(;gvm.tkidx<gvm.tokens.length&&!gvm.stop;){if(peek("endfor")){gvm.loopcnt++,gvm.tkidx=o;break}process()}t.val+=r,gvm.vars.set(e,t),console.log(t.val)}for(;"endfor"!==next().val;);return!0}),parser_table.set("if",function(){const e=expr(4);eat("then");for(var t=tobool(e);gvm.tkidx<gvm.tokens.length&&!gvm.stop&&!peek("endif");)peek("else")&&(next(),t=!t),t?process():next()}),parser_table.set("return",function(){gvm.returnv=expr(4),endf()}),parser_table.set("endfunction",function(){endf()}),parser_table.set("endprocedure",function(){endf()}),parser_table.set("input",function(){if(!match("wd"))throw"INPUT后需要一个变量";return gvm.inputname=next().val,gvm.inputting=!0,gvm.output("[等待输入中...]"),document.getElementById("runbtn").setAttribute("class","layui-btn layui-btn-disabled"),!0}),parser_table.set("output",function(){gvm.output(expr(4).val)});const nil_val={type:"nil",val:"nil"};function isnumeric(e){return"integer"===e.type||"real"===e.type}function get_prio(e){return"^"===e?4:"+"===e||"-"===e||"&"===e?3:"*"===e||"/"===e||"%"===e?2:"and"===e||"or"===e?1:["<",">","="].includes(e)?0:void 0}function cmptype(e,t){const n=["integer","real"];return!(!n.includes(e.type)||!n.includes(t.type))||e.type===t.type}function fakeparm(){eat("(");const e=expr(4);return eat(")"),e}function fakecall(){eat("("),eat(")")}function expr(e=3,t=!1){var n=0;const r=next();var o=nil_val;if("not"===r.val)o={type:"bool",val:!tobool(o=expr(4))};else if("-"===r.val||"+"===r.val){if("integer"!==(o=expr(-1)).type&&"real"!==o.type)throw"无法将类型 `"+o.type+"` 转为 integer!";o.val="-"===r.val?-o.val:o.val}else if("("===r.val){if(peek(")"))return nil_val;o=expr(4),eat(")")}else if("asc"===r.val){const e=fakeparm();if("string"!==e.type)throw"ASC函数必须作用于char类型上!";o={type:"integer",val:e.val.charCodeAt(0)}}else if("chr"===r.val){const e=fakeparm();if("integer"!==e.type)throw"CHR函数必须作用于integer类型上!";o={type:"string",val:String.fromCharCode(e.val)}}else if("tonum"===r.val){const e=fakeparm();if("string"!==e.type)throw"TONUM函数必须作用于string类型上!";o={type:"real",val:Number.parseFloat(e.val)}}else if("rnd"===r.val)fakecall(),o={type:"real",val:Math.random()};else if("int"===r.val){const e=fakeparm();if("real"!==e.type)throw"int函数必须作用于string类型上!";o={type:"integer",val:Math.floor(e.val)}}else if("wd"===r.type){const e=gvm.vars.get(r.val);if(void 0===e)throw"无法找到变量:`"+r.val+"`";const t=e.val;if(peek("["))if("string"===e.type){next();const e=expr(4);eat("]"),o=e.val<0||e.val>=t.length?{type:"string",val:"undefined"}:{type:"string",val:t[e.val]}}else{if("array"!==e.type)throw"变量 "+r.val+" 不是一个数组!";next();for(var l=[];;){const e=expr(4);if(!isnumeric(e))throw"数组索引必须是整数！";if(l.push(Math.floor(e.val)),!peek(","))break;next()}if(eat("]"),console.log(l.length+","+t.val.length),l.length!==t.val.length)throw"数组 维度不匹配";n="";l.forEach((e,r)=>{if(t.val[r].l>e||t.val[r].r<e)throw"数组访问越界！ "+e+" , ["+t.val[r].l+","+t.val[r].r+"]";n+=e+","}),void 0===(o=t.ctx.get(n))&&(o={type:t.type,val:"未定义的值"}),avisit=n}else if(peek("(")){next();const e=t.parm,n=gvm.vars;var a=new Map,i=0;a=structuredClone(n);for(let t of e.keys()){const e=expr(4);if(a.set(t,e),i++,!peek(","))break;next()}if(i!==e.size)throw"调用参数数量不匹配";console.log(a),eat(")","可能是参数不匹配？"),gvm.stacks.push({vars:n,pc:gvm.tkidx}),gvm.vars=a,gvm.tkidx=t.pc,console.log(gvm);try{execute(void 0,gvm.output,!0,!1)}catch(e){if("endfunction"!=e)throw e;o=gvm.returnv,console.log(e)}}else o={type:e.type,val:e.val}}else"number"===r.type?o={type:"real",val:r.val}:"string"===r.type&&(o=r);for(;e;){if(!match("calc")&&!peek("and")&&!peek("or"))return o;const t=next(),l=get_prio(t.val),a=t.val;if("<"===a&&peek("-")&&4===e){eat("-");const t=expr(e-1);if("wd"!==r.type)throw"赋值语句左侧必须是一个变量";if(!cmptype(o,t))throw"无法将类型 `"+t.type+"` 赋值给 `"+o.type+"`!";return 0!==n?gvm.vars.get(r.val).val.ctx.set(n,t):gvm.vars.set(r.val,t),{type:"bool",val:!0}}if(!(l<=e))return gvm.tkidx--,o;{if("<"===t.val){if(peek("=")){next();const e=expr(4);if(isnumeric(o)&&isnumeric(e))return{type:"bool",val:o.val<=e.val};throw"比较运算必须在 两个 数值之间"}if(peek(">")){next();const e=expr(4);return{type:"bool",val:o.val!==e.val}}const e=expr(4);if(isnumeric(o)&&isnumeric(e))return{type:"bool",val:o.val<e.val};throw"比较运算必须在 两个 数值之间"}if(">"===t.val){if(peek("=")){next();const e=expr(4);if(isnumeric(o)&&isnumeric(e))return{type:"bool",val:o.val>=e.val};throw"比较运算必须在 两个 数值之间"}const e=expr(4);if(isnumeric(o)&&isnumeric(e))return{type:"bool",val:o.val>e.val};throw"比较运算必须在 两个 数值之间"}if("or"===t.val){const e=expr(4);return{type:"bool",val:tobool(o)||tobool(e)}}if("and"===t.val){const e=expr(4);return{type:"bool",val:tobool(o)&&tobool(e)}}if("="===t.val){const e=expr(4);return{type:"bool",val:o.val===e.val}}const e=expr(l-1);if(isnumeric(o)&&isnumeric(e))"+"===a||"-"===a?o.val="+"===a?o.val+e.val:o.val-e.val:"*"===a||"/"===a?o.val="*"===a?o.val*e.val:o.val/e.val:"^"===a?o.val=Math.pow(o.val,e.val):"%"===a&&(o.val=o.val%e.val);else{if("&"!==a&&"+"!==a)throw"比较运算必须在 两个 数值之间!"+o.type+" "+e.type;if("string"!==o.type&&"integer"!==o.type&&"real"!==o.type)throw"字符串拼接必须在两个string类型之间!";o.val=o.val+e.val}}}return o}function process(){if(match("kwd")){const e=next();parser_table.has(e.val)&&parser_table.get(e.val)()}else match("newline")?next():console.log(expr(4))}function execute(e,t,n=!1,r=!0){for(n||(cleangvm(e),gvm.output=t,gvm.vars.set("stdlib",{type:"string",val:codes_stdlib}));gvm.tkidx<gvm.tokens.length&&!gvm.stop;){if(gvm.inputting)return;try{process()}catch(e){if(r){t("运行时错误，在第"+gvm.tokens[gvm.tkidx-1].col+"行，原因："+e);break}throw e}}console.log(gvm)}